

<!DOCTYPE html>

<html>

    <head>
        <meta http-equiv="content-language" content="es">
        <meta charset="utf-8">
        <title>Title of the document</title>

        <link rel="stylesheet" href="https://waloncab.github.io/s.ln_blog/assets/css/body.css">

        

<script type="module">
  import mermaid from 'https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>



    </head> 

    <body>

        <div class="content">

            <ul><li><a href="#TFG">TFG</a></li><ul><li><a href="#resumen">resumen</a></li><li><a href="#planificación">planificación</a></li><ul><li><a href="#justificación">justificación</a></li><li><a href="#alcance">alcance</a></li><li><a href="#metodología">metodología</a></li><li><a href="#EDT">EDT</a></li><li><a href="#entregables">entregables</a></li><li><a href="#tiempos">tiempos</a></li><li><a href="#gantt">gantt</a></li><li><a href="#rrhh">rrhh</a></li><li><a href="#comunicaciones">comunicaciones</a></li><li><a href="#riegos">riegos</a></li></ul><li><a href="#análisis">análisis</a></li><ul><li><a href="#AGRAI-data">AGRAI-data</a></li><li><a href="#requisitos">requisitos</a></li></ul><li><a href="#diseño">diseño</a></li><ul><li><a href="#BD-DESIGN">BD-DESIGN</a></li><li><a href="#modelo-BD">modelo-BD</a></li><li><a href="#services">services</a></li></ul><li><a href="#implementación">implementación</a></li><ul><li><a href="#infraestructure">infraestructure</a></li><li><a href="#entorno">entorno</a></li><li><a href="#commands-CLI">commands-CLI</a></li><li><a href="#pipeline">pipeline</a></li><ul><li><a href="#model-view">model-view</a></li><li><a href="#pipe_itr_0">pipe_itr_0</a></li></ul></ul><li><a href="#seguimiento">seguimiento</a></li></ul></ul>

            <div id=TFG><h1>1 TFG</h1><p>[[resumen]]</p>
<p>[[planificacin]]</p>
<p>[[anlisis]]</p>
<p>[[diseo]]</p>
<p>[[implementacin]]</p>
<p>[[seguimiento]]</p></div><div id=resumen><h2>2 resumen</h2><p>Pipeline de Datos para una Aplicacin de datosAgroalimentarios.</p>
<p>Resumen: El trabajo consistir en la reestructuracin de una aplicacin de gestin de datos agroalimentarios con el objetivo de soportar la gestin y el mantenimiento de los datos de diferentes clientes. Estos datos, actualmente, se actualizan e incrementan de forma peridica con un aadido de trabajo manual que se puede optimizar mediante tcnicas de integracin y despliegue continuo.</p></div><div id=planificación><h2>2 planificación</h2><p>esto sobra</p>
<ul>
<li>
<p>INTRODUCCIN</p>
<ul>
<li>Antecedentes [[justificacin]]</li>
</ul>
</li>
<li>
<p>PLANIFICACIN</p>
<ul>
<li>Alcance [[alcance]]</li>
<li>Metodologia [[metodologa]]</li>
<li>EDT [[EDT]]</li>
<li>Entregables [[entregables]]</li>
<li>Tiempos [[tiempos]]</li>
<li>GANTT [[gantt]]</li>
<li>Recursos Humanos [[rrhh]]</li>
<li>Plan de comunicaciones [[comunicaciones]]</li>
<li>Anlisis de Riesgos [[riegos]]</li>
</ul>
</li>
<li>
<p>ANLISIS</p>
<ul>
<li>Discusin Pipeline (Reuninones)</li>
<li>Revisin de la Estructura del diseo anterior.</li>
<li>Explicacin Diseo</li>
</ul>
</li>
<li>
<p>DISEO (entregables)</p>
<ul>
<li>Explicacin Diseo Actual</li>
<li>Estructura Excel Datos de Entrada (snippet)</li>
<li>Preprocesamiento Datos </li>
<li>Diseo Vista Minable</li>
</ul>
</li>
<li>
<p>TAREAS</p>
<ul>
<li>Modelo de Datos<ul>
<li>Transformacin de datos + Justificacin de features</li>
<li>DOC datos entrada</li>
</ul>
</li>
<li>Entorno<ul>
<li>herramientas integracin continua equipo</li>
<li>Django + jupyter notebooks.</li>
</ul>
</li>
<li>Implementacin pipeline<ul>
<li>infraestructura<ul>
<li>Entorno Linux + automatizacin .sh</li>
<li>Instalacin en varias mquinas</li>
</ul>
</li>
<li>carga de datos Inicial (1S)</li>
<li>seleccin de caractersticas</li>
<li>transformacin de datos</li>
<li>obtencin vista minable</li>
<li>implementacin modelo de produccin de cultivo</li>
<li>visualizacin resultados en la interfaz</li>
</ul>
</li>
<li>Implementacin modelo Produccin</li>
<li>Pipeline Jenkins (automatizacin de la instalacin de la applicacion y despliegue) _&gt; solo si llego.</li>
<li>Depliegue de la interfaz (esta preparada ?)</li>
</ul>
</li>
<li>
<p>TEST Y PRUEBAS</p>
<ul>
<li>Integracin de nuevos datos para la aplicacin y comprobacin del correcto funcionamiento de los modelos.</li>
<li>Prueba del cdigo en BD de forma paralela. (durante todo el desarrollo de la aplicacin)</li>
</ul>
</li>
<li>
<p>MEMORIA</p>
<ul>
<li>Redaccin de Memoria (20 h)</li>
</ul>
</li>
<li>
<p>SEGUIMIENTO Y CONTROL (MANTENIMIENTO)</p>
<ul>
<li>observacin del nuevo flujo de trabajo a partir del rediseo de software.</li>
<li>durante de todo el proyecto (sin estipular)</li>
<li>varias pruebas de carga de datos</li>
</ul>
</li>
</ul></div><div id=justificación><h3>3 justificación</h3><ul>
<li>partimos de un rediseo de BD anterior.</li>
<li>buscamos automatizar los modelos de produccin ()</li>
<li>necesitamos una arquitectura limpia.</li>
</ul>
<p>Necesidad de una reestructuracin para la aplicacin agrai por su crecimiento para la gestin de grandes volmenes de datos agrarios. El estado actual de dicha aplicacin consiste en la representacin del estado de cierto parcelario a travs del anlisis de histricos de datos.</p></div><div id=alcance><h3>3 alcance</h3><p>El proyecto planteado inicialmente por la empresa tiene una planificacin de cuatro meses, pero mi estancia en la empresa no puede prolongarse durante tanto tiempo. As, aprovechando que el proyecto se va a desarrollar siguiendo una metodologa incremental iterativa se considera que realice las tres primeras iteraciones como mi TFG adems de realizar la planificacin de este.</p>
<p>A continuacin, se expondrn los objetivos generales del proyecto con la intencin de aportar una visin global del trabajo que se pretende realizar. Para evaluar el xito de la realizacin de mi TFG se plantear en la fase de anlisis de cada iteracin unos requisitos a partir de los cules se podr valorar el desarrollo de mi TFG y la influencia que tendr mi aportacin en el proyecto final.</p>
<p>Los objetivos finales del proyecto son:</p>
<ul>
<li>Automatizar el despliegue de la aplicacion mediante infraestructura como cdigo.</li>
<li>Disear un modelo de datos que permita un rapido escalado de dicha app.</li>
<li>Automatizacin del proceso de trasformacin de los datos mediante el diseo de un pipeline.</li>
<li>Obtencin de un modelo de produccin de cultivo para el parcelario (kg)</li>
<li>Inclusin de los resultados en la presentacin de la applicacin.</li>
<li>Integracin continua mediante pruebas de test para el pipeline desarrollado<ul>
<li>(si fuese posible llegar a Jenkins)</li>
</ul>
</li>
</ul></div><div id=metodología><h3>3 metodología</h3><p>En el equipo hacemos uso de SCRUM para la gestin del proyecto. Dicha metodologa permite un desarrollo en cascada de las diferentes tareas propuestas para la creacin del pipeline.</p>
<p>2.4. MTODO DE TRABAJO  </p>
<p>Se usar un ciclo de vida iterativo e incremental. Dentro de las fases del proyecto (tambin<br />
llamadas iteraciones), se repiten de manera intencionada una o ms actividades del<br />
proyecto. Con estas iteraciones el entendimiento del producto por parte del equipo va<br />
aumentando. Las fases (iteraciones) desarrollan el producto a travs de una serie de ciclos<br />
repetidos, mientras que los incrementos van aadiendo sucesivamente funcionalidad al<br />
producto. En definitiva, consiste en varios ciclos de vida en cascada. Al final de cada<br />
iteracin se entrega una versin mejorada.</p></div><div id=EDT><h3>3 EDT</h3><p>Mostramos el desglose de las tareas ms importantes para la correcta realizacin del proyecto.</p>
<div class="mermaid">
graph TD;
TFG-->PLANIFICACIN;
TFG-->ANLISIS;
TFG-->DISEO;
TFG-->IMPLEMENTACIN;
PLANIFICACIN-->ALCANCE;
PLANIFICACIN-->METODOLOGIA;
PLANIFICACIN-->EDT;
PLANIFICACIN-->ENTREGABLES;
PLANIFICACIN-->TIEMPOS;
PLANIFICACIN-->GANTT;
PLANIFICACIN-->RRHH;
PLANIFICACIN-->COMUNICACIONES;
PLANIFICACIN-->RIESGOS;
ANLISIS-->PREVIOS;
ANLISIS-->REQUISITOS;
REQUISITOS-->FUNCIONALES:
REQUISITOS-->NO_FUNCIONALES;
DISEO-->ARQUITECTURA;
IMPLEMENTACIN-->PIPELINE;
PIPELINE-->PIPE.1_D;
PIPELINE-->PIPE.2_D;
</div>

<h2>Tareas y Descripcin:</h2>
<table>
<thead>
<tr>
<th>First Header</th>
<th>Second Header</th>
</tr>
</thead>
<tbody>
<tr>
<td>Content from cell 1</td>
<td>Content from cell 2</td>
</tr>
<tr>
<td>Content in the first column</td>
<td>Content in the second column</td>
</tr>
</tbody>
</table>
<script>mermaid.initialize({startOnLoad:true});</script></div><div id=entregables><h3>3 entregables</h3><p>tabla con los entregables y las descripciones:</p>
<table>
<thead>
<tr>
<th align="left">Tables can be justified with a colon</th>
<th align="right">Another example with a long title</th>
<th align="center">And another long title as a example</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">because of the <code>:</code></td>
<td align="right">these will be justified</td>
<td align="center">this is centered</td>
</tr>
</tbody>
</table></div><div id=tiempos><h3>3 tiempos</h3><table>
<thead>
<tr>
<th align="left">Tables can be justified with a colon</th>
<th align="right">Another example with a long title</th>
<th align="center">And another long title as a example</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">because of the <code>:</code></td>
<td align="right">these will be justified</td>
<td align="center">this is centered</td>
</tr>
</tbody>
</table>
<p>tabla con las tareas y tiempos</p></div><div id=gantt><h3>3 gantt</h3><p>https://gist.github.com/martinwoodward/8ad6296118c975510766d80310db71fd</p>
<p>El siguiente diagrama propone un desglose de tareas para la planificacin del proyecto. </p>
<div class="mermaid">
gantt
title Planificacin
dateFormat  DD-MM
axisFormat  %d

section ANALISIS
ALCANCE: done, 01-01, 2d
METODOLOGIA: crit, 02-01, 3d
EDT: 03-01, 5d
GANNT: 04-01, 5d
RRHH: 05-01, 3d
COMUNICACIONES: 06-01, 5d
RIESGOS: 07-01, 5d

section MODELO_DATOS
RELACIONES BD: done, 08-01, 15d
REDISEO: crit, 09-01, 15d

section ENTORNO
DJANGO+JUPYTER: done, 10-01, 2d
INT_CONTINUA: crit, 11-01, 3d

section PIPELINE
INFR: 20-01, 5d
LOAD: 21-01, 5d
FEAT: 25-01, 5d
VIEW: 25-01, 7d
MODEL: 30-01, 7d
WEB: 30-01, 5d
Phase 2 complete: milestone, 30-01, 0d

section TEST
TEST 1: 20-01, 30d
TEST 2: 30-01, 20d
TEST 3: milestone, 20-02, 1d

section MEMORIA
MEM_WRITE: 01-01, 60d
SEG_Y_CONT: 01-01, 60d


Project complete: milestone, 10-03, 0d
</div>

<p>Este diagrama es una estipulacin de cmo creo que voy a ir durante el desarrollo del modelo de datos y del pipeline correspondiente. En la seccion final de seguimiento y control analizamos las desviaciones encontradas y cmo han sido solucionados estos contratiempos.</p>
<script>mermaid.initialize({startOnLoad:true});</script></div><div id=rrhh><h3>3 rrhh</h3><p>El personal implicado en el Trabajo de Fin de Grado ser:  </p>
<p>Alberto Esteban Larreina: Ejecutor y responsable del proyecto. Desarrollar el proyecto en su totalidad.  </p>
<p>Antonio Rbio: Tutor en la empresa. Se dedicar a corregir los aspectos tcnicos del proyecto referentes al desarrollo  del mismo y planificacin.</p>
<p>Jnathan Heras: Tutor acadmico<br />
Se dedicar a corregir aspectos referentes a la documentacin y la forma en la que<br />
se desarrollar el proyecto a lo largo del tiempo estipulado y me guiar a cerca del<br />
desarrollo de este.</p></div><div id=comunicaciones><h3>3 comunicaciones</h3><p>2.3. PLAN DE COMUNICACIONES  </p>
<p>Para mantener informados tanto al tutor acadmico como a la tutora de la empresa, utilizaremos los siguientes canales:  </p>
<p>Reuniones: presenciales, tanto con el tutor acadmico como con el tutor de la empresa.  </p>
<p>Email: se utilizar como forma de comunicacin electrnica para concretar<br />
determinadas pautas o establecimiento de citas.  </p>
<p>Discord: aplicacin de comunicacin interna para mensajes directos con los miembors del equipo.</p></div><div id=riegos><h3>3 riegos</h3><ul>
<li>fallo de la obtencin de features necesarias.</li>
<li>datos externos con nuevas caractersticas no contempladas en la BD</li>
<li>cambios en el alcance</li>
<li>planificacin demasiado exhaustiva</li>
</ul>
<p>TABLA DE RIESGOS:</p>
<table>
<thead>
<tr>
<th align="left">Tables can be justified with a colon</th>
<th align="right">Another example with a long title</th>
<th align="center">And another long title as a example</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">because of the <code>:</code></td>
<td align="right">these will be justified</td>
<td align="center">this is centered</td>
</tr>
</tbody>
</table></div><div id=análisis><h2>2 análisis</h2><p>[[AGRAI-data]]</p>
<p>[[requisitos]]</p></div><div id=AGRAI-data><h3>3 AGRAI-data</h3><p>Explicacin del estado actual del proyecto:</p>
<p>AGRAIes una aplicacin para la gestin de cultivo que permite al agricultor monitorizar el estado de sus paracelas. El estado actual de la aplicacin se centra el despliegue de datosgeoreferenciadospor medio de una interfaz web. Los resultados para el usuario de la aplicacin son satisfactorios permitiendo a ste consultar el estado de su parcelario junto con algunas predicciones en cualquier momento. </p>
<p>Por otro lado, como actualmente se procesa la informacin que finalmente muestra la aplicacin es un porceso tedioso para el equipo, en el cul diferentes miembros trabajan contecnologasdistintas sobre datos duplicados obtenidos de fuentes comunes para finalmente mostrar un resultado en la aplicacin.</p>
<p>El objetivo de este trabajo de fin de grado es mejorar y automatizar el flujo de trabajo del equipo convirtiendo la aplicacin AGRAI en una herramienta robusta que manipule un nico repositorio de datos al cul el resto del equipo pueda acceder y utilizar de forma segura y lo ms importante, sin duplicar y romper la integridad de los datos.</p>
<p>Entiendo que es un proyecto ambicioso debido a que no slo es importante el conocimiento tcnico sino que sern necesarios cambios en la forma de trabajo del equipo adems de la confianza de cada miembro por la nueva forma de trabajo que se desea implementar.</p></div><div id=requisitos><h3>3 requisitos</h3><p>descripcin de requisitos funcionales:</p>
<table>
<thead>
<tr>
<th align="left">REQUISITO</th>
<th align="right">DESCRIPCIN</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">RF1</td>
<td align="right">automatizar el despliegue de la aplicacin identificando las libreras y dependencias necesarias</td>
</tr>
<tr>
<td align="left">RF2</td>
<td align="right">redisear el modelo de datos para poder escalar la aplicacin y su gestin de datos.</td>
</tr>
<tr>
<td align="left">RF3</td>
<td align="right">creacin de un entorno comn que permita trabajar al equipo sobre las mismos datos con tecnlogas comunes.</td>
</tr>
</tbody>
</table>
<p>RF9 acceder a los datos de produccin a travs de un API rest -&gt; django REST.</p>
<p>descripcion de requisitios no funcionales:
tecologas y dems.</p>
<table>
<thead>
<tr>
<th align="left">REQUISITO</th>
<th align="right">DESCRIPCIN</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">RNF1</td>
<td align="right"></td>
</tr>
<tr>
<td align="left">RNF2</td>
<td align="right"></td>
</tr>
<tr>
<td align="left">RNF3</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p>ampliaciones</p></div><div id=diseño><h2>2 diseño</h2><p>[[BD-DESIGN]]</p>
<p>[[modelo-BD]]</p>
<p>[[services]]</p></div><div id=BD-DESIGN><h3>3 BD-DESIGN</h3></div><div id=modelo-BD><h3>3 modelo-BD</h3><p>Como inicio del pipeline, se reestructura la arquitectura de la aplicacin junto con su BD para soportar el almacenamiento de nuevos datos. El siguiente esquema de BD es el resultado de la implementacin de la parte de anlisis descrita en el planteamiento.</p>
<p>Es importante destacar que este esquema propuesto </p>
<p>
<figure class="class1"><img src="figures/modelo-BD.png" title="title" /><figcaption>caption</figcaption></figure>
</p>
<p>Para la creacin de este modelo he trabajado con el equipo en la identificacin de los conceptos que necesitaban ser representados. El diseo en papel da la posibilidad de pensar abiertamente sobre las relaciones entre entidades adems de permitir la transmisin de ideas de forma sencilla durante las reuniones.</p>
<p>Dentro del entorno de trabajo de <em>Django,</em> el ORM proporcionado asla la base de datos y nos permite disear directamente en <em>Python</em> dicho modelo. Las entidades se disean como clases y las relaciones entre ellas se especifican mediante el lenguaje de mapeo proporcionado, de dicha forma creamos las claves forneas que fsicamente contiene la base de datos.</p>
<p>La utilizacin de este ORM es una ventaja que nos evita usar SQL directamente y permite poblar la base de datos mediante comandos <em>Python</em> desde la terminal. De todas formas, la localizacin fsica de la BD necesita ser enlazada correctamente. Este aislamiento, posibilita utilizar diferentes bases de datos en los entornos locales y de produccin.</p>
<p>Varias etapas han sido necesarias hasta llegar a un punto ms o menos estable. La herramienta <em>Graphviz</em> ha permitido obtener diagramas UML que visualizan la estructura de clases del modelo a partir del cdigo. Esta representacin grfica ha sido realmente til para poder pensar sobre el diseo a medida que avanzaba.</p>
<h2>Entidades Principales</h2>
<p>Del inicio anterior, nos quedamos solo con las entidades principales.</p>
<p>
<figure><img src="figures/spectralgeo_db.png" title="original" /><figcaption>caption</figcaption>
</figure>
</p>
<p>Este rediseo contempla la mayora de casos posibles para el posterior tratamiento y procesamiento de dataos, con posibilidad de crear buenos modelos predictivos. A continuacin se describen las entidades principales contempladas en la base de datos.</p>
<table>
<thead>
<tr>
<th align="left">ENTIDAD</th>
<th align="right">DESCRIPCIN</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Parcela</td>
<td align="right">Como toda la informacin que se va a almacenar es referente a las parcelas y sus datos, toda la BD gira en torno a la tabla Parcela.</td>
</tr>
<tr>
<td align="left">Indice</td>
<td align="right">Esta taba es de vital importancia para el funcionamiento de la aplicacin, toda nuestra informacin lleva a estos datos. Sern datos calculados en un dominio, esto se hace as ya que existen cientos de formas de denominar un mismo ndice de vegetacin y podra ser un desastre a la hora de realizar las consultas. Para ello se establecern algunos campos determinados en el campo tipo_indice y se les dar un valor en valor_indice.</td>
</tr>
<tr>
<td align="left">Campaa</td>
<td align="right">Es una tabla muy importante, sirve para unir distintos tipos de registros (desde variedades hasta labores de campo pasando por unir los datos de parcelas y subparcelas).</td>
</tr>
<tr>
<td align="left">Cultivo</td>
<td align="right">Esta tabla est directamente unida a la anterior, ya que un cultivo puede tener muchas variedades diferentes (Ej: Guisante es un tipo de cultivo, pero tiene varias variedades: tirabeque, snap peas).</td>
</tr>
</tbody>
</table>
<h2>Diseo de Cultivo</h2>
<p>explicacin sobre la forma de modelado recurisva para la entidad cultivo.</p>
<p>EXP CULT REC</p>
<div class="mermaid">
erDiagram
CULTIVO ||--o{ CULTIVO : is
CULTIVO {
string nombre FK
string descripcion
string es_variedad FK
}
</div>

<h2>Diseo de Roles</h2>
<p>La aplicacin contempla que diferentes usuarios puedan realizar diferentes acciones. El diseo modular del modelo de datos permite al equipo aadir diferentes roles sin estos estar "hardcoded" en el cdigo de la aplicacin. La siguiente tabla muestra los roles hasta ahora creados por el equipo y su relacin con el parcelario.</p>
<p>Roles necsarios para la organizacin jerrquica necesaria en una organizacin agraria. Estos roles permiten agrupara diferentes funciones que encontramos en el software diseadas como diferntes servicos.</p>
<table>
<thead>
<tr>
<th align="left">ROL</th>
<th align="right">DESC</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Agricultor</td>
<td align="right">usuario de las parcelas</td>
</tr>
<tr>
<td align="left">Cooperativa</td>
<td align="right">entidad que agrupa a tcnos con diferentes cargos sobre un parcelario</td>
</tr>
<tr>
<td align="left">Tecnico</td>
<td align="right">personal asignado a un nmero de parcelas.</td>
</tr>
</tbody>
</table>
<h2>Diseo de ndices</h2>
<p>El trabajo con ndices vegetativos por parte del equipo es uno de los puntos ms importantes para que el rediseo sea satisfactorio. A continuacin mostramos cmo las relaciones identificadas van ha permitr una correcta bsqueda de features para despus poder estimar con precin en el modelo de produccin de cultivo.</p>
<div class="mermaid">
erDiagram
INDICE ||--o{ MIRAR_INDICE : allows
INDICE {
string nombre FK
string descripcion
}
PIXEL ||--o{ MIRAR_INDICE : is
PIXEL ||--o{ PARCELA : is
PIXEL {
string parcela FK
polygon geom
string idx
}
PARCELA {
string idx
string estacion
float altitud
polygon geom
}
MIRAR_INDICE {
string indice FK
string pixel FK
date fecha
geojson json
float valor
}
</div>

<script>mermaid.initialize({startOnLoad:true});</script></div><div id=services><h3>3 services</h3><p>Los servicios son la siguiente capa de abstraccin, explicamos por qu son importantes y cmo nos permiten encapsular el diseo de las consultas ms frecuentes sobre el modelo de la applicacin.</p>
<p>Como estamos utilizando el ORM de Django, para no sobrecargar los objetos del modelo con demasiados mtodos establecemos un mdulo de servicios con las consultas ms frecuentes. Este mdulo ayuda a mantener el cdigo en el modelo limpio sin complejidad aadida debido a que las consltas / mtodos que hacen uso de varias relaciones quedan como entidades separadas que se pueden reutilizar.</p>
<p>La siguiente funcin es una de las ms usadas debido a la integracin directa con el proceso de descarga de imgenes satelitales del cultivo.</p>
<pre><code>def get_indice_func(parcela, indice_p, fecha_p, func, filtro):

    indice_p = Indice.objects.get(nombre=indice_p) 
    if type(indice_p) == str else indice_p

    if ParcelaIndices_Service.is_parcela_filter(parcela, filtro):

      pixels = parcela.get_pixeles()

      indices_pixels = Mirar_Indice.objects.filter(

          pixel__in = pixels, 
          indice = indice_p, 
          fecha = fecha_p
      )

      if ParcelaIndices_Service.get_indice_filter(indices_pixels, filtro):

        array_valores = list(indices_pixels.values_list('valor', flat=True))

        return func(array_valores)

      else:
        return None
    else:
      return None
</code></pre></div><div id=implementación><h2>2 implementación</h2><p>[[infraestructure]]</p>
<p>[[entorno]]</p>
<p>[[commands-CLI]]</p>
<p>[[pipeline]]</p></div><div id=infraestructure><h3>3 infraestructure</h3><p>Parte del rediseo consiste en la automatizacin del despliege de la applicacion. En este punto vemos como la infraestructura como cdigo permite aislar las librerias necesarias creando un script que deja una mquina en estado estable para ejecutar la aplicacin.</p>
<p>Para poder utilizar tecnologas que posibiliten la integracin continua transformamos el entorno de desarrollo desplegando la aplicacin en UNIX. Identificacmos las siguientes dependencias que necesitan ser instaladas:</p>
<ul>
<li>postgres 14 con el plug-in de postgis para trabajar con datos georeferenciados.</li>
<li>python3.8</li>
<li>Django</li>
<li>requierement for virtual env.</li>
</ul>
<p>El siguiente script automatiza la creaccin de una mquina con las librerias necesarias, el cul una vez ejecutado, deja la aplicacin lista para su despligue.</p>
<pre><code class="language-bash">
#!/bin/bash

sudo apt update
sudo apt upgrade
sudo apt install software-properties-common
sudo add-apt-repository ppa:deadsnakes/ppa

# postgres

sudo apt-get install openjdk-8-jdk
sudo apt-get install openjdk-8-jre
sudo apt-get install postgresql postgresql-contrib postgis postgresql-10-postgis-2.4
sudo -u postgres createuser -P geoserver

# como creo el rol

sudo -u postgres createdb -O geoserver geoserver
sudo -u postgres psql -c &quot;CREATE EXTENSION postgis; CREATE EXTENSION postgis_topology;&quot; geoserver

# gdal native:

sudo add-apt-repository ppa:ubuntugis/ppa &amp;&amp; sudo apt-get update
sudo apt-get update

# replace config postgres files

sudo cp ./postgresql.conf /etc/postgresql/10/main
sudo cp ./pg_hba.conf /etc/postgresql/10/main

# python

sudo apt install python3.8
sudo apt install virtualenv
sudo apt install python3.8-dev python3.8-venv

# creacion entorno_venv

python3.8 -m venv agrai_venv

# env gdal lib variables

export CPLUS_INCLUDE_PATH=/usr/include/gdal
export C_INCLUDE_PATH=/usr/include/gdal

# install dep in python agrai_venv

source agrai_venv/bin/activate
pip install --upgrade pip # quitar
python -m pip install -r ./requirements.txt

</code></pre></div><div id=entorno><h3>3 entorno</h3><p>Es importante preparar un entrno comn para el equipo. Django es un framework muy tilpor la integracin de las herramientas que hemos visto (ORM, web-interfaces, etc), pero para conseguir un workflow adecuado necesitamos incluir otra herramientas propias de ciencia de datos como pueden ser cuadernos de jupyter y sus entornos con las libreras necesarias para ejecutar modelos predictivos.</p>
<p>Migracin de todo el enterno a UNIX para posteriomente utilizar herramientas de integracin continua. El trabajo en el quipo local se hace a travs de una mquina en WSL para trabajar de forma semejante a un contender. Uno de los problemas principales para el quipo en su flujo de trabajo ha sido mantener una integridad entre el desarrollo realizad por los diferentes miembros del equipo y el posterior despliegue de la aplicacin en un entorno UNIX diferente al que se haba utilizado en local en las versiones de preproduccin.</p>
<p>Dedicamos varios das a prepar la integracin de Django con cuadernos jupyter y adems poder ejecutar diferentes entornos virtuales con las librerias adecuadas en cada momento. Los siguientes ejemplos muestran como se ha conseguido integrar las libreras necesarias para el despliegue de los cuadernos y su integracin con los datos y los modelos de Django.</p>
<p>CODE -&gt; snippet example -&gt; django integration:</p>
<p>IPYNB -&gt; cdigo con el cuaderno dentro de este punto</p>
<p>INTEGRACIN CREACIN -&gt; DESPLIEGUE DE MODELOS:</p>
<p>Para el trabajo interno de la aplicacin ncesitamos entornos con libreras ms pesadas como sklearn, numpy, scikit-learn, etc que no deberamos usar en la produccin de solo la interfaz web que simplemente muestra los datos del parcelario registrado con su produccin estimada.</p></div><div id=commands-CLI><h3>3 commands-CLI</h3><p>Una de las caractersticas ms tiles del framework en nuestro caso es la posibilidad de crear comandos que se ejecuten desde dentro.</p>
<pre><code class="language-python">
from django.core.management.base import BaseCommand

class Command(BaseCommand):
    def handle(self, **options):
        # now do the things that you want with your models here

</code></pre>
<p>Con esta estructura desarrollamos la infraestructura necesaria para cargar los datos en el modelo. Podemos crear varios entornos con tuberas deferentes que den como resultado aplicaciones con estados distintos, caracterstica muy importante debido al funcionamiento del equipo en relacin a el procesamiento de datos  con varios clientes.</p></div><div id=pipeline><h3>3 pipeline</h3><ul>
<li>Implementacin pipeline (TAREAS)
        - carga de datos Inicial (1S)
        - seleccin de caractersticas
        - transformacin de datos
        - obtencin vista minable
        - implementacin modelo de produccin de cultivo
        - visualizacin resultados en la interfaz<ul>
<li>Implementacin modelo Produccin</li>
<li>Pipeline Jenkins (automatizacin de la instalacin de la applicacion y despliegue)</li>
<li>Depliegue de la interfaz (esta preparada ?)</li>
</ul>
</li>
</ul>
<p>Es importante diferenciar qu tipo de estructura estamos construyendo. Existen actualmente varias arquitecturas para pipelines como pueden ser ETLs u otras. Para la correcta creacin del modelo de produccin no utilizarmos ninguna de estas arquitecturas, sino que disearemos los bloques necesarios en cada paso para llegar a una vista minable que podamos utilizar.</p>
<p>Tenemos tres conceptos que definen un pipeline de datos. Para nuestra aplicacin nos centramos en utilizar el repositorio anterior para obtener y gestionar los datos necesarios del parcelario y transformar aquellos campos que definen una parcela en la vista minable correspondiente al modelo de produccin.</p>
<ul>
<li>
<p>Data Ingestion: utilizamos nuestra BD para extrar a travs de Django los datos necesarios. Las relaciones establecidas anterioremente permiten un fcil acceso a estos datos.</p>
</li>
<li>
<p>Data Transformation: una vez identificadas las relaciones, extraemos las campos necesarios y creamos el esquema de la vista minable que utilizaremos en el modelo. Una vez ejecutado el modelo podemos pasar al siguiente punto</p>
</li>
<li>
<p>Data Storage: es necesario persistir los datos obtenidos por el modelo ya que forman parte de los datos objetivos para seguir modelizando correctamente el cultivo.</p>
</li>
</ul>
<p>(intencin, justificar cmo hemos ido haciendo el proceso de transformacin de datos para obtener el modelo.)</p>
<p>ITERACIONES:</p>
<p>[[model-view]]</p>
<p>[[pipe_itr_0]]</p></div><div id=model-view><h4>4 model-view</h4><p>Para la creacin de la vista minable utilizamos la relaciones de la BD, centrandonos en los indices registrados en diferentes fechas propuestas. (en este caso utilizamos 4 fechas ya que son suficientes para el modelo de produccin)</p>
<p>-&gt; insertar codigo aqui con la construccin de la vista</p>
<p>-&gt; insertar cuadernos jupyter dentro del entrno html que estoy desplegando para mostrar la vista minable creada. </p>
<p>-&gt; as evito la generacin de imgenes.</p>
<h1>escribir en el html la referencia al cuaderno y ejecutarlo.</h1></div><div id=pipe_itr_0><h4>4 pipe_itr_0</h4><p>Mediante los comandos de de django creamos diferentes tuberas para la prueba de datos. El siguiente cdigo carga en la aplicacin datos de prueba para poder probar el modelo.  </p>
<pre><code class="language-python">
class Command(LoggingBaseCommand):

  help = 'Carga la geometra a las parcelas y a los pixeles'

  BASE_DIR = Path(__file__).resolve().parent.parent.parent.parent
  PARCELA_SHAPE = BASE_DIR / 'data' / 'parcelas' / '25' / 'parcelas.shp'
  PIXEL_SHAPE = BASE_DIR / 'data' / 'parcelas' / '25' / 'pixeles.shp'
  FICHERO_PATH = BASE_DIR / 'data' / 'excels' / 'datos-test-2.xls'
  TRILINEA_PATH = BASE_DIR / 'data' / 'trilineas' / 'PRilineas.json'

  def handle(self, *args, **kwargs):

    self.run()

  def run(self):

    # execute in order:

    print(Path(self.PARCELA_SHAPE))

        call_command('1-load-qgis',parcelas=self.PARCELA_SHAPE, pixels=self.PIXEL_SHAPE)

    call_command('2-load-parcela-data', excel=str(self.FICHERO_PATH))

    call_command('3-load-cultivos', excel=str(self.FICHERO_PATH))

    # mirar que puedo ejecutar ms veces el comando

    for i in range(0,10):

      call_command('4-random-ndvi')

    call_command('5-create-models')

    call_command('6-create-roles')

</code></pre></div><div id=seguimiento><h2>2 seguimiento</h2><p>hacemos uso de una metodologa kai-zen que permite seguir la implementacin y los devios que han sucedido sobre el plantemiento del proyecto.</p>
<p>El objetivo de este trabajo no es obtener un producto software final sino la optimizacin de un proceso o flujo de trabajo. Los cambios planteados mejoran el acceso a los datos y la forma de prorcesar estos por el resto de participantes del equipo. </p>
<p>Durante el avance del proyecto se han ido documentando algunas lecciones aprendidas en el siguiete blog. Estas pequeas notas documentan algunos de los problemas que pueden volver a aprecer. La mayora de estas publicaciones son relacionadas con problemas de arquitectura de software relacionados con el framework que se est utilizando, Django. Adems encontramos cdigo que permite automizar la visualizacin de ciertos procesos que ayudan a optimzar el proceso de trabajo.</p>
<ul>
<li>blog-post 1</li>
<li>blog-post 2</li>
<li></li>
</ul></div>

        <div>

    </body>

</html>

